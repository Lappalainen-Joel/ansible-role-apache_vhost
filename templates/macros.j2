{# {% import "macros.j2" as apache_macros with context %} #}
{% macro rewrite_block(rewrites) %}
{% if rewrites is defined %}
# Various rewrite rules.
<IfModule mod_rewrite.c>
  RewriteEngine on
{% for rewrite in rewrites %}
{{rewrite}}
{% endfor %}
</IfModule>
{% endif %}
{% endmacro %}

{% macro redirect_vhost(vhost) %}
<VirtualHost *:80>
{%        for hostname in vhost.hosts %}
{%            if loop.first %}
            ServerName {{ hostname }}
{% if loop.length > 1 %}
            ServerAlias{% endif %}{%
            else %} {{ hostname }}{% endif %}
{%        endfor %}
{{ rewrite_block(vhost.rewrites) }}

        RedirectPermanent / http://www.{{ site_name }}/{{ vhost.destination_path|default('') }}
</VirtualHost>
{% endmacro %}
